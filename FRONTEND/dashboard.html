<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel - Amigo Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Lora:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style> 
        body { font-family: 'Inter', sans-serif; } 
        h1, h2, h3 { font-family: 'Lora', serif; } 
    </style>
</head>
<body class="bg-slate-50 text-slate-700">

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-10 shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html"><h1 class="text-2xl font-bold text-slate-800">Amigo Digital</h1></a>
            <button id="logout-button" class="font-medium text-red-600 hover:underline">Sair</button>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-16">
        <div class="max-w-3xl mx-auto">
            <h2 class="text-4xl font-bold text-slate-900 mb-4">Bem-vindo(a)!</h2>
            <p class="text-lg text-slate-600 mb-10">Peça ajuda ou sugira novos tutoriais para a comunidade. As ideias mais votadas se tornarão tutoriais oficiais!</p>

            <div class="bg-white p-6 rounded-lg shadow-md mb-10">
                <h3 class="text-2xl font-bold text-slate-800 mb-4">Tem uma ideia para um tutorial?</h3>
                <form id="suggestion-form">
                    <textarea id="suggestion-text" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" rows="3" placeholder="Ex: Como fazer uma chamada de vídeo no WhatsApp?" required></textarea>
                    <button type="submit" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-md hover:bg-blue-700 transition-colors">
                        Enviar Sugestão
                    </button>
                </form>
            </div>

            <div>
                <h3 class="text-2xl font-bold text-slate-800 mb-6">Sugestões da Comunidade</h3>
                <div id="suggestions-list" class="space-y-4">
                    <p id="loading-message">Carregando sugestões...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // *******************************************************************
        // CONFIGURE AQUI SUAS CHAVES DO SUPABASE
        // *******************************************************************
        const SUPABASE_URL = 'https://xcdezoxlrswpxaglcudj.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjZGV6b3hscnN3cHhhZ2xjdWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NzE5NTYsImV4cCI6MjA3NDE0Nzk1Nn0.Yg_1XesRSP-_IocH2Qdi9dhqsjuJkjDc9K3NThtywwk';
        // *******************************************************************

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- ELEMENTOS DA PÁGINA ---
        const logoutButton = document.getElementById('logout-button');
        const suggestionForm = document.getElementById('suggestion-form');
        const suggestionText = document.getElementById('suggestion-text');
        const suggestionsList = document.getElementById('suggestions-list');
        const loadingMessage = document.getElementById('loading-message');

        // --- FUNÇÕES ---

        /**
         * Busca e exibe todas as sugestões ativas.
         */
        async function fetchSuggestions() {
            const { data, error } = await _supabase
                .from('suggestions')
                .select('*')
                .order('votes', { ascending: false }); // Ordena pelas mais votadas

            if (error) {
                console.error('Erro ao buscar sugestões:', error);
                suggestionsList.innerHTML = '<p class="text-red-500">Não foi possível carregar as sugestões.</p>';
                return;
            }

            // Limpa a lista antes de adicionar os itens
            suggestionsList.innerHTML = ''; 

            if (data.length === 0) {
                 suggestionsList.innerHTML = '<p class="text-slate-500">Ainda não há sugestões. Que tal ser o primeiro?</p>';
            } else {
                 data.forEach(suggestion => {
                    const suggestionElement = createSuggestionElement(suggestion);
                    suggestionsList.appendChild(suggestionElement);
                });
            }
        }

        /**
         * Cria o elemento HTML para uma única sugestão.
         */
        function createSuggestionElement(suggestion) {
            const div = document.createElement('div');
            div.className = 'bg-white p-5 rounded-lg shadow-sm flex justify-between items-center transition-all duration-300';
            div.id = `suggestion-${suggestion.id}`;

            div.innerHTML = `
                <p class="text-slate-800">${suggestion.content}</p>
                <div class="flex items-center gap-4">
                    <span class="font-bold text-xl text-blue-600">${suggestion.votes}</span>
                    <button data-id="${suggestion.id}" class="vote-button bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-md hover:bg-blue-200 transition-colors">
                        Votar
                    </button>
                </div>
            `;
            return div;
        }
        
        /**
         * Lida com o envio do formulário de nova sugestão.
         */
        suggestionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = suggestionText.value.trim();

            if (content) {
                // Insere a nova sugestão na tabela
                const { error } = await _supabase
                    .from('suggestions')
                    .insert({ content: content, votes: 1 }); // Começa com 1 voto

                if (error) {
                    console.error('Erro ao adicionar sugestão:', error);
                    alert('Não foi possível enviar sua sugestão.');
                } else {
                    suggestionText.value = ''; // Limpa o campo
                    fetchSuggestions(); // Atualiza a lista
                }
            }
        });

        /**
         * Lida com cliques nos botões de votar.
         */
        suggestionsList.addEventListener('click', async (e) => {
            if (e.target && e.target.classList.contains('vote-button')) {
                const suggestionId = e.target.getAttribute('data-id');
                e.target.disabled = true; // Desabilita para prevenir cliques duplos
                e.target.textContent = 'Votando...';

                // Usamos uma Função do Supabase para incrementar o voto de forma segura
                const { data, error } = await _supabase.rpc('increment_votes', { suggestion_id: suggestionId });

                if (error) {
                    console.error('Erro ao votar:', error);
                    alert('Ocorreu um erro ao registrar seu voto.');
                    e.target.disabled = false;
                    e.target.textContent = 'Votar';
                } else {
                    const newVotes = data;
                    // Se a sugestão atingiu o limite, remova-a da tela
                    if (newVotes >= 20) {
                        const elementToRemove = document.getElementById(`suggestion-${suggestionId}`);
                        elementToRemove.style.transform = 'scale(0.9)';
                        elementToRemove.style.opacity = '0';
                        setTimeout(() => elementToRemove.remove(), 300);
                        // A lógica de "promover para tutorial" seria feita no banco de dados.
                        // Por exemplo, a função RPC poderia mudar um status para 'aprovado'.
                    } else {
                        // Apenas atualiza a contagem na tela
                        const voteCountElement = document.querySelector(`#suggestion-${suggestionId} span`);
                        voteCountElement.textContent = newVotes;
                        e.target.disabled = false;
                        e.target.textContent = 'Votar';
                    }
                }
            }
        });
        
        // --- AUTENTICAÇÃO ---
        logoutButton.addEventListener('click', async () => {
            const { error } = await _supabase.auth.signOut();
            if (!error) {
                window.location.href = 'index.html';
            }
        });

        // --- INICIALIZAÇÃO ---
        // Carrega as sugestões assim que a página é aberta
        fetchSuggestions();

    </script>
</body>
</html>